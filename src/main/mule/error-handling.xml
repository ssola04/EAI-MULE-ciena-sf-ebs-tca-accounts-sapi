<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:db="http://www.mulesoft.org/schema/mule/db"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" 
	xmlns:dw="http://www.mulesoft.org/schema/mule/ee/dw"
	xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="
http://www.mulesoft.org/schema/mule/ee/dw http://www.mulesoft.org/schema/mule/ee/dw/current/dw.xsd http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd">



	<error-handler name="globalError_Handler" doc:id="390d3734-d191-48c9-9700-120afbfd5e17">
	<on-error-continue type="APIKIT:BAD_REQUEST" enableNotifications="true" logException="true">
                <ee:transform xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd" doc:id="4c92b570-3ead-4a14-a07b-2a4186e4310f">
                    <ee:message>
                    </ee:message>
                    <ee:variables>
                        <ee:set-variable variableName="httpStatus"><![CDATA[400]]></ee:set-variable>
                    </ee:variables>
                </ee:transform>
			<flow-ref doc:name="global-prepare-error-response-sub-flow" doc:id="09e797b0-4426-47bb-9b82-1b71524b2384" name="global-prepare-error-response-sub-flow" />
            
</on-error-continue>
            <on-error-continue type="APIKIT:NOT_FOUND" enableNotifications="true" logException="true">
                <ee:transform xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd" doc:id="10a3deaf-fbee-4afe-9819-8a848a487a22">
                    <ee:message>
                    </ee:message>
                    <ee:variables>
                        <ee:set-variable variableName="httpStatus"><![CDATA[404]]></ee:set-variable>
                    </ee:variables>
                </ee:transform>
			<flow-ref doc:name="global-prepare-error-response-sub-flow" doc:id="2ecb5e20-4d15-44e8-8a06-c0ad0bf37886" name="global-prepare-error-response-sub-flow" />
            
</on-error-continue>
            <on-error-continue type="APIKIT:METHOD_NOT_ALLOWED" enableNotifications="true" logException="true">
                <ee:transform xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd" doc:id="63ad6f4f-ae18-4940-bfd1-7a6200f4d2d0">
                    <ee:message>
                    </ee:message>
                    <ee:variables>
                        <ee:set-variable variableName="httpStatus"><![CDATA[405]]></ee:set-variable>
                    </ee:variables>
                </ee:transform>
			<flow-ref doc:name="global-prepare-error-response-sub-flow" doc:id="464ec21e-0fec-40bf-8aa1-822e4b768844" name="global-prepare-error-response-sub-flow" />
            
</on-error-continue>
            <on-error-continue type="APIKIT:NOT_ACCEPTABLE" enableNotifications="true" logException="true">
                <ee:transform xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd" doc:id="a865328d-c6ff-4227-ab67-a8d487076a10">
                    <ee:message>
                    </ee:message>
                    <ee:variables>
                        <ee:set-variable variableName="httpStatus"><![CDATA[406]]></ee:set-variable>
                    </ee:variables>
                </ee:transform>
			<flow-ref doc:name="global-prepare-error-response-sub-flow" doc:id="7a51b522-f8bc-40cb-9246-a052b8cbb8d1" name="global-prepare-error-response-sub-flow" />
            
</on-error-continue>
            <on-error-continue type="APIKIT:UNSUPPORTED_MEDIA_TYPE" enableNotifications="true" logException="true">
                <ee:transform xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd" doc:id="1effb75c-0159-45b6-862a-800bcbf8eaf9">
                    <ee:message>
                    </ee:message>
                    <ee:variables>
                        <ee:set-variable variableName="httpStatus"><![CDATA[415]]></ee:set-variable>
                    </ee:variables>
                </ee:transform>
			<flow-ref doc:name="global-prepare-error-response-sub-flow" doc:id="71769f2f-d938-4a2c-84c4-6294a2925d6c" name="global-prepare-error-response-sub-flow" />
            
</on-error-continue>
            <on-error-continue type="APIKIT:NOT_IMPLEMENTED" enableNotifications="true" logException="true">
                <ee:transform xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd" doc:id="0f260977-4130-4aab-bf17-c3ac737a4397">
                    <ee:message>
                    </ee:message>
                    <ee:variables>
                        <ee:set-variable variableName="httpStatus"><![CDATA[501]]></ee:set-variable>
                    </ee:variables>
                </ee:transform>
			<flow-ref doc:name="global-prepare-error-response-sub-flow" doc:id="4ade67d2-41a3-4ade-9ec2-8e16088a1bf3" name="global-prepare-error-response-sub-flow" />
            
</on-error-continue>
	<on-error-continue enableNotifications="true" doc:name="On Error Continue" when='#[error.errorType.namespace == "DB"]' logException="true">
		
	<set-variable value="#[500]" doc:name="Set the HTTP Status - 500" doc:id="bc81614c-1172-4edb-8737-0c0a165e4e76" variableName="httpStatus"/>
      <flow-ref doc:name="global-prepare-error-response-sub-flow" doc:id="9c8347a0-f3f1-454e-8e6b-952f701037cb" name="global-prepare-error-response-sub-flow"/>
		
	</on-error-continue>

		

		<!-- DB Related issues -->

		<!-- HTTP Requster Related error handling -->

		<!-- If none of the above matches then handle a the exception using generic handler -->
		<on-error-continue type="ANY" enableNotifications="true" logException="true" doc:name="On Error Continue" doc:id="3d922113-aae1-4ea6-be28-286937cbccf0">
			<set-variable value="#[500]" doc:name="Set HTTP Status - 500" variableName="httpStatus"/>
			<flow-ref doc:name="global-prepare-error-response-sub-flow" doc:id="58cfc980-54ae-4e2f-b656-03c667e2a26a" name="global-prepare-error-response-sub-flow"/>
		</on-error-continue>
		
		

	

</error-handler>
	<sub-flow name="global-prepare-error-response-sub-flow" doc:id="5b4a5970-fbb2-4231-8a47-db03348a717a">
		
		<ee:transform doc:name="Compose Error Payload" doc:id="077fc353-10d2-484f-a769-78046cfdaca3">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
	"error-code": vars.httpStatus,
	"error-type": if(error.errorType != null) error.errorType.namespace ++ ":" ++ error.errorType.identifier  else 'Error',
	"timestamp": now() as String { format: "yyyy-MM-dd'T'HH:mm:ss" },
	"message": if(vars.errorMessage != null and vars.errorMessage != '') vars.errorMessage else if(error.description != null) error.description else 'error',
	"external-correlation-id": vars."external-correlation-id"
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>


    
</sub-flow>

	
</mule>	